name: Branch Preview Cleanup

on:
  pull_request:
    types: [closed]
  delete:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch name to delete preview for (e.g. my-feature-branch)"
        required: true
        type: string

permissions:
  contents: write

concurrency:
  group: branch-preview-cleanup
  cancel-in-progress: false

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Resolve branch name + decide whether to skip
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          # Single-source-of-truth branch name for each event type:
          # - PR closed: PR head branch
          # - delete: deleted ref name (branch or tag)
          # - workflow_dispatch: input
          BRANCH="${{ github.event.pull_request.head.ref || github.event.ref || inputs.branch }}"

          # Skip tag deletions
          if [[ "${{ github.event_name }}" == "delete" && "${{ github.event.ref_type }}" != "branch" ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Never touch gh-pages
          if [[ "$BRANCH" == "gh-pages" ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Checkout gh-pages
        if: steps.vars.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Delete preview folder + push commit (only if it existed)
        if: steps.vars.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail

          # Hard safety: only operate on gh-pages
          CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD)"
          if [[ "$CURRENT_BRANCH" != "gh-pages" ]]; then
            echo "Not on gh-pages (on $CURRENT_BRANCH). Refusing."
            exit 1
          fi

          PREVIEW_DIR="branch-preview/${{ steps.vars.outputs.branch }}"

          # Hard safety: only allow deletions under branch-preview/
          if [[ "$PREVIEW_DIR" != branch-preview/* || "$PREVIEW_DIR" == "branch-preview/" ]]; then
            echo "Suspicious delete path: $PREVIEW_DIR"
            exit 1
          fi

          if [[ ! -d "$PREVIEW_DIR" ]]; then
            echo "No preview folder found for ${{ steps.vars.outputs.branch }}; nothing to do."
            exit 0
          fi

          rm -rf "$PREVIEW_DIR"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "Remove branch preview for ${{ steps.vars.outputs.branch }}"
          git push
